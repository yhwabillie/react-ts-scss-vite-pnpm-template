@use 'sass:list' as list;
@use 'sass:meta' as meta;
@use 'sass:map' as map;
@use 'sass:string';
@use '../variables' as vars;
@use '../mixins/rem' as mix;
@use '../functions' as fn;

// Font-Family 변수 생성
@mixin generate-vars-font-family($prefix, $locales: null) {
  @each $lang in $locales {
    $properties: map.get(vars.$g_font-family, $lang);

    @if $properties == null or list.length($properties) == 0 {
      @warn "No font defined for locale `#{$lang}`.";
      @continue;
    }

    $cleaned: ();
    @each $item in $properties {
      @if $item != null and $item != '' {
        $cleaned: list.append($cleaned, $item, comma);
      }
    }

    @each $item in vars.$g_font-family-default-fallbacks {
      $cleaned: list.append($cleaned, $item, comma);
    }

    $cleaned: list.append($cleaned, sans-serif, comma);

    $font-family-str: '';
    $len: list.length($cleaned);
    @for $i from 1 through $len {
      $font-family-str: $font-family-str + list.nth($cleaned, $i);
      @if $i != $len {
        $font-family-str: $font-family-str + ', ';
      }
    }

    --#{$prefix}-font-family-#{$lang}: #{$font-family-str};
  }
}

// Font-Weight 변수 생성
@mixin generate-vars-font-weight($prefix, $properties) {
  @each $key, $value in $properties {
    --#{$prefix}-font-weight-#{$key}: #{$value};
  }
}

// Border-Radius 변수 생성
@mixin generate-vars-border-radius($prefix, $properties) {
  @each $key, $value in $properties {
    --#{$prefix}-border-radius-#{$key}: #{$value};
  }
}

// Tablet Typography 변수 생성
@mixin generate-vars-typography-tablet($lang) {
  @each $type, $locales in vars.$g_typography {
    $style: map.get($locales, $lang);
    @if $style == null {
      @continue;
    }

    // ✅ Deprecation Warning 해결: @if 문으로 할당
    $tablet-size-raw: null;
    @if map.has-key($style, tablet-size) {
      $tablet-size-raw: map.get($style, tablet-size);
    }
    @if not $tablet-size-raw {
      @continue;
    }

    $weights: fn.ensure-list(map.get($style, font-weight));
    $line: map.get($style, line-height);
    $family-var: string.unquote('var(--#{vars.$g_project-name}-font-family-#{$lang})');

    @each $weight in $weights {
      $font-tablet-rem: #{$weight} #{mix.rem($tablet-size-raw)}/#{$line} #{$family-var};
      // ✅ 대소문자 이슈 해결: string.to-lower-case
      $var-base: --#{vars.$g_project-name}-typo-#{string.to-lower-case($type)}-#{$weight};
      #{$var-base}: #{$font-tablet-rem};
    }
  }
}

// Mobile Typography 변수 생성
@mixin generate-vars-typography-mobile($lang) {
  @each $type, $locales in vars.$g_typography {
    $style: map.get($locales, $lang);
    @if $style == null {
      @continue;
    }

    $weights: fn.ensure-list(map.get($style, font-weight));

    // ✅ 기존 if() 함수 대신 @if 문으로 안전하게 할당
    $mobile-size-raw: null;
    @if map.has-key($style, mobile-size) {
      $mobile-size-raw: map.get($style, mobile-size);
    }

    @if not $mobile-size-raw {
      @continue;
    }

    $line: map.get($style, line-height);
    $family-var: string.unquote('var(--#{vars.$g_project-name}-font-family-#{$lang})');

    @each $weight in $weights {
      $font-mobile-rem: #{$weight} #{mix.rem($mobile-size-raw)}/#{$line} #{$family-var};
      $var-base: --#{vars.$g_project-name}-typo-#{string.to-lower-case($type)}-#{$weight};

      #{$var-base}: #{$font-mobile-rem};
    }
  }
}

// Lang 속성에 따라 Typograhy 변수 생성
@mixin generate-vars-lang-typography() {
  $lang-map: ();

  @each $type, $locales in vars.$g_typography {
    @each $locale, $style in $locales {
      $weights: fn.ensure-list(map.get($style, font-weight));
      $size-rem: mix.rem(map.get($style, font-size));
      $line: map.get($style, line-height);
      $family-key: map.get($style, font-family);
      $family-var: string.unquote('var(--#{vars.$g_project-name}-font-family-#{$family-key})');

      @each $weight in $weights {
        // ✅ string.to-lower-case 적용하여 --project-typo-code-400 형태로 생성
        $var-name: --#{vars.$g_project-name}-typo-#{string.to-lower-case($type)}-#{$weight};
        $value: #{$weight} #{$size-rem}/#{$line} #{$family-var};
        $entry: (
          $var-name: $value,
        );

        @if map.has-key($lang-map, $locale) {
          $lang-map: map.merge(
            $lang-map,
            (
              $locale: list.append(map.get($lang-map, $locale), $entry, comma),
            )
          );
        } @else {
          $lang-map: map.merge(
            $lang-map,
            (
              $locale: (
                  $entry,
                ),
            )
          );
        }
      }
    }
  }

  @each $locale, $styles in $lang-map {
    html[lang='#{$locale}'] {
      font-family: var(--#{vars.$g_project-name}-font-family-#{$locale});

      @each $style-map in $styles {
        @if meta.type-of($style-map) == 'map' {
          @each $prop, $val in $style-map {
            #{$prop}: #{$val};
          }
        }
      }

      @media (max-width: 768px) {
        @include generate-vars-typography-tablet($locale);
      }

      @media (max-width: 480px) {
        @include generate-vars-typography-mobile($locale);
      }
    }
  }
}

/**
 * 테마별 컬러 변수 생성 믹스인 (프로젝트 Prefix 포함)
 * @param {String} $theme-name - "light" 또는 "dark"
 * @param {Map} $g_colors - 컬러 데이터 맵
 */
@mixin generate-theme-vars($theme-name, $g_colors) {
  $theme-map: map.get($g_colors, $theme-name);
  $project-prefix: vars.$g_project-name;

  @if $theme-map {
    @each $key, $value in $theme-map {
      /** * 결과 예시:
       * --project-color-surface-default: #ffffff;
       */
      --#{$project-prefix}-#{$key}: #{$value};
    }
  } @else {
    @warn "Theme '#{$theme-name}'를 찾을 수 없습니다.";
  }
}
