@use 'sass:list' as list;
@use 'sass:meta' as meta;
@use 'sass:map' as map;
@use 'sass:string';
@use '../variables' as vars;
@use '../mixins/rem' as mix;

/* --------------------------------------------
 * ë‹¨ì¼ ê°’ â†’ ë¦¬ìŠ¤íŠ¸
 * ------------------------------------------ */
@function _as-list($v) {
  @return if(meta.type-of($v) == 'list', $v, ($v));
}

// Font-Family ë³€ìˆ˜ ìƒì„±
@mixin generate-vars-font-family($prefix, $locales: null) {
  @each $lang in $locales {
    // ì–¸ì–´ë³„ í°íŠ¸ ê°€ì ¸ì˜¤ê¸°
    $properties: map.get(vars.$g_font-family, $lang);

    // null/ë¹ˆ ê°’ ì²´í¬
    @if $properties == null or list.length($properties) == 0 {
      @warn "No font defined for locale `#{$lang}`.";
      @continue;
    }

    // ì‚¬ìš©ì ì •ì˜ ê°’ ì •ë¦¬
    $cleaned: ();
    @each $item in $properties {
      @if $item != null and $item != '' {
        $cleaned: list.append($cleaned, $item, comma);
      }
    }

    // ê¸°ë³¸ fallback ì¶”ê°€
    @each $item in vars.$g_font-family-default-fallbacks {
      $cleaned: list.append($cleaned, $item, comma);
    }

    // ë§ˆì§€ë§‰ sans-serif
    $cleaned: list.append($cleaned, sans-serif, comma);

    // font-family ë¬¸ìì—´ ìƒì„±
    $font-family-str: '';
    $len: list.length($cleaned);
    @for $i from 1 through $len {
      $font-family-str: $font-family-str + list.nth($cleaned, $i);
      @if $i != $len {
        $font-family-str: $font-family-str + ', ';
      }
    }

    // CSS ë³€ìˆ˜ ìƒì„±
    --#{$prefix}-font-family-#{$lang}: #{$font-family-str};
  }
}

// Font-Weight ë³€ìˆ˜ ìƒì„±
@mixin generate-vars-font-weight($prefix, $properties) {
  @each $key, $value in $properties {
    --#{$prefix}-font-weight-#{$key}: #{$value};
  }
}

// Border-Radius ë³€ìˆ˜ ìƒì„±
@mixin generate-vars-border-radius($prefix, $properties) {
  @each $key, $value in $properties {
    --#{$prefix}-border-radius-#{$key}: #{$value};
  }
}

// Mobile Typograhy ë³€ìˆ˜ ìƒì„±
@mixin generate-vars-typography-mobile($lang) {
  @each $type, $locales in vars.$g_typography {
    // $langì— í•´ë‹¹í•˜ëŠ” ìŠ¤íƒ€ì¼ë§Œ ê°€ì ¸ì˜¤ê¸°
    $style: map.get($locales, $lang);
    @if $style == null {
      @continue;
    }

    $weights: _as-list(map.get($style, font-weight));
    $mobile-size-raw: if(map.has-key($style, mobile-size), map.get($style, mobile-size), null);
    @if not $mobile-size-raw {
      @continue;
    }

    $line: map.get($style, line-height);

    // ì–¸ì–´ë³„ font-family CSS ë³€ìˆ˜ ì°¸ì¡°
    $family-var: string.unquote('var(--#{vars.$g_project-name}-font-family-#{$lang})');

    @each $weight in $weights {
      $font-mobile-rem: #{$weight} #{mix.rem($mobile-size-raw)}/#{$line} #{$family-var};
      $var-base: --#{vars.$g_project-name}-typo-#{$type}-#{$weight};

      // âœ… ë³€ìˆ˜ëª…ì€ ê·¸ëŒ€ë¡œ, ê°’ë§Œ ë³€ê²½
      #{$var-base}: #{$font-mobile-rem};
    }
  }
}

// Lang ì†ì„±ì— ë”°ë¼ Typograhy ë³€ìˆ˜ ìƒì„±
@mixin generate-vars-lang-typography() {
  $lang-map: ();

  @each $type, $locales in vars.$g_typography {
    @each $locale, $style in $locales {
      $weights: _as-list(map.get($style, font-weight));
      $size-rem: mix.rem(map.get($style, font-size));
      $line: map.get($style, line-height);
      $family-key: map.get($style, font-family);

      // â— ì—¬ê¸°ì„œ font-family ë¥¼ CSS ë³€ìˆ˜ ì°¸ì¡°ë¡œ ë³€ê²½
      // ì˜ˆ: var(--project-font-family-ko)
      $family-var: string.unquote('var(--#{vars.$g_project-name}-font-family-#{$family-key})');

      @each $weight in $weights {
        $var-name: --#{vars.$g_project-name}-typo-#{$type}-#{$weight};
        $value: #{$weight} #{$size-rem}/#{$line} #{$family-var};
        $entry: (
          $var-name: $value,
        );

        // ì–¸ì–´ mapì— ëˆ„ì 
        @if map.has-key($lang-map, $locale) {
          $lang-map: map.merge(
            $lang-map,
            (
              $locale: list.append(map.get($lang-map, $locale), $entry, comma),
            )
          );
        } @else {
          $lang-map: map.merge(
            $lang-map,
            (
              $locale: (
                  $entry,
                ),
            )
          );
        }
      }
    }
  }

  // ìµœì¢… ì¶œë ¥
  @each $locale, $styles in $lang-map {
    // @debug 'ğŸ”  #{inspect($locale)}';

    html[lang='#{$locale}'] {
      // ì–¸ì–´ë³„ font-family ì§ì ‘ ì ìš©
      font-family: var(--#{vars.$g_project-name}-font-family-#{$locale});

      @each $style-map in $styles {
        @if meta.type-of($style-map) == 'map' {
          @each $prop, $val in $style-map {
            #{$prop}: #{$val};
          }
        }
      }

      @media (width < 768px) {
        // @include typography-mobile-px(false);
      }

      @media (max-width: 375px) {
        @include generate-vars-typography-mobile($locale);
      }
    }
  }
}
